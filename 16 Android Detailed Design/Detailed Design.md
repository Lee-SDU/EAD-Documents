# 详细设计

### 数据存储

使用SharedPreferences作为数据存储，涉及到存储模块有装车确认及内部转移，首次进入主页面获取转移单数据并保存，在装车确认详情操作后返回装车确认页面进行同步，同步成功后重新获取转移单数据并覆盖保存，若同步失败则不进行数据获取，每次返回主页面时判断转移单数据是否已同步，若已同步则获取最新的转移单数据并保存，若没有同步则执行同步操作，同步成功后获取最新转移单数据并缓存，同步失败在不获取最新数据，并提示同步失败，用户需手动同步。

### 权限设计

app权限根据登录用户的角色不同而加载不同的模块，登录接口返回的角色(role_mobile_res)参数(详见登录接口)是“装车确认,内部转移,固废入库,内部利用,固废出库”中的一种或几种，根据返回的数据启用相应的模块

### 版本设计

app没有涉及应用内升级功能，若app有功能升级，则以重新安装的形式进行升级，打包时许注意版本号应大于上个版本号，版本名原则上没有限制，建议以x.y.z的形式命名，修复及优化在z上体现，小功能升级在y上体现，大功能升级在x上体现

### 安全设计

app的安全策略采用token认证方式实现，在所有http请求中，将用户帐号、时间戳、密钥进行md5加密作为token，同时将用户帐号，时间戳、token参数传入http头中，后台服务器进行比对，根据比对成功与否，返回相应的数据或提示认证失败(详见下文中加扣认证)

### 登陆机制

app采用两种登录方式，在线帐户密码登录及离线刷卡登录，在线帐户密码登录方式实时调用接口，后台服务器校验账号，将校验信息返回给app，app通过返回信息作相应处理，校验通过，则登录成功跳转到主页面，校验不通过则登录失败，提示失败信息；离线刷卡登录方式是程序每次打开时，将可登录系统的卡信息缓存在本地，刷卡时将卡信息和缓存的卡信息进行比对，比对信息成功，则登录成功，跳转到主页面，比对信息失败，提示失败信息

### 扫描二维码接口说明

程序加载时初始化扫描二维码驱动并注册监听，当按扫描键触发扫描操作时，扫描设备驱动会获取和处理数据，并将得到的数据返回给监听程序，监听器得到数据后回调程序处理业务的方法，进行相应的操作(调用接口等)，程序完全退出时，注销监听器，释放相应资源。

### 接口说明

应用涉及到的所有接口使用同一的接口认证方式和统一的异常处理方式，这里统一说明

#### 接口认证

接口认证采用用户帐号、时间戳、密钥组合加密方式认证，所有接口的认证信息都在请求报头中体现

支持格式 `JSON`

HTTP请求方式 `POST` `GET` `PUT` `DELETE`

请求参数

|参数|必选|类型及范围|说明|
|-|-|-|-|
|userId|true|string|登录人帐号(卡同步接口和帐号密码登录接口可传null)|
|time|true|string|当前时刻的Unix时间戳|
|token|true|string|userId、time和密钥经过md5加密生成|

示例
```
{
    "userId": "clxie",
    "time": "1469607566",
    "token": "5ece831702283ec26aa690a0bba214a3"
}
```

#### 错误说明

所有接口返异常的方式如下

支持格式 `JSON`

示例
```
{
    "code": 500,
    "content": "认证异常，请检查设备时间或与管理员联系",
    "error": "ERROR_AUTH_FAILED",
    "type": "failed"
}
```

返回结果说明

|参数|类型及范围|说明|
|-|-|-|
|code|int|错误代码|
|content|string|错误详情|
|error|string|错误说明|
|type|string|类型|
